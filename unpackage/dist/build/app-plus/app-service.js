if("undefined"==typeof Promise||Promise.prototype.finally||(Promise.prototype.finally=function(e){const t=this.constructor;return this.then((n=>t.resolve(e()).then((()=>n))),(n=>t.resolve(e()).then((()=>{throw n}))))}),"undefined"!=typeof uni&&uni&&uni.requireGlobal){const e=uni.requireGlobal();ArrayBuffer=e.ArrayBuffer,Int8Array=e.Int8Array,Uint8Array=e.Uint8Array,Uint8ClampedArray=e.Uint8ClampedArray,Int16Array=e.Int16Array,Uint16Array=e.Uint16Array,Int32Array=e.Int32Array,Uint32Array=e.Uint32Array,Float32Array=e.Float32Array,Float64Array=e.Float64Array,BigInt64Array=e.BigInt64Array,BigUint64Array=e.BigUint64Array}uni.restoreGlobal&&uni.restoreGlobal(Vue,weex,plus,setTimeout,clearTimeout,setInterval,clearInterval),function(e){"use strict";function t(e,t,...n){uni.__log__?uni.__log__(e,t,...n):console[e].apply(console,[...n,t])}__definePage("pages/index/index",((e,t)=>{const n=e.__vccOpts||e;for(const[i,a]of t)n[i]=a;return n})({data:()=>({title:"text",texts:[],text:"",canConnect:!0,canChat:!1,canTalk:!1,extraLine:[],isConnected:!1,inputContentValue:"",showClearIcon:!1}),methods:{connectWebSocket(){let e=this;t("log","at pages/index/index.vue:46","调用连接websocket"),this.socketTask=uni.connectSocket({url:"ws://124.70.89.172:9527",success(n){t("log","at pages/index/index.vue:50","WebSocket连接成功"),uni.showToast({title:"WebSocket连接成功",icon:"none"}),e.isConnected=!0},fail(e){t("log","at pages/index/index.vue:59","报错",e)}}),this.socketTask.onOpen((function(n){t("log","at pages/index/index.vue:64","WebSocket连接已打开！"),e.isConnected=!0;let i={};i.request_id=e.guid(),i.format="utf-8",i.timestamp=1620358489,i.version=1,i.command="connect";let a={uuid:"123456"};i.data=a;let o=JSON.stringify(i);e.sendWebSocketMessage(o)})),this.socketTask.onMessage((function(n){t("log","at pages/index/index.vue:82","收到服务器内容："+n.data),e.handlerMsg(JSON.parse(n.data))})),this.socketTask.onError((function(n){t("log","at pages/index/index.vue:86","WebSocket连接打开失败，请检查！"),t("log","at pages/index/index.vue:87",n),e.isConnected=!1})),this.socketTask.onClose((n=>{t("log","at pages/index/index.vue:95","WebSocket连接关闭！"),clearInterval(e.timer),e.timer="",e.isClose})),t("log","at pages/index/index.vue:102",this.socketTask)},reconnectWebSocket(){t("log","at pages/index/index.vue:107","进入断线重连"),this.socketTask=null,this.connectWebSocket()},sendWebSocketMessage(e){return t("log","at pages/index/index.vue:115","发送信息"),t("log","at pages/index/index.vue:116",e),new Promise(((n,i)=>{this.socketTask.send({data:e,success(e){t("log","at pages/index/index.vue:121","发送成功"),n(e)},fail(e){t("log","at pages/index/index.vue:125","发送失败"),t("log","at pages/index/index.vue:126",e),i(e)}})}))},heart(){let e=this;clearInterval(this.timer),this.timer="";let n={type:"heartbeat"};this.timer=setInterval((()=>{e.sendSocketMessage(JSON.stringify(n)).then((e=>{t("log","at pages/index/index.vue:143","心跳成功")})).catch((e=>{t("log","at pages/index/index.vue:145","发送失败"),t("log","at pages/index/index.vue:146",e)}))}),2e5)},closeWebSocket(){this.socketTask.close({success(){uni.showToast({title:"WebSocket关闭成功",icon:"none"})}})},handlerMsg(e){t("log","at pages/index/index.vue:166",e),e.request_id;let n=e.data,i=n.command;if("connect"==i)this.extraLine.pop(),this.extraLine.push("连接中...连接成功"),this.text=this.extraLine.join("\n"),this.canChat=!0,this.canTalk=!0;else if("chat"==i){let e=n.type;if("text"==e){let e=n.content;this.extraLine.push("机器人："+e),this.text=this.extraLine.join("\n"),this.texts.push("AI:"+e)}else if("audio"==e){let e=n.content;const i=uni.createInnerAudioContext();i.autoplay=!0,i.src=e,i.onPlay((()=>{t("log","at pages/index/index.vue:193","开始播放")})),i.onError((e=>{t("log","at pages/index/index.vue:196",e.errMsg),t("log","at pages/index/index.vue:197",e.errCode)}))}}},connect:function(e){0==this.isConnected?(this.extraLine.push("连接中..."),this.text=this.extraLine.join("\n"),this.connectWebSocket()):(this.isConnected=!1,this.extraLine.push("断开连接"),this.text=this.extraLine.join("\n"),this.closeWebSocket())},composeContent:function(e){this.texts.push("Human:"+this.inputContentValue);let n="";for(let t of this.texts)n+=t,n+="\n";return t("log","at pages/index/index.vue:225","text="+n),n},chat:function(e){t("log","at pages/index/index.vue:230",this.inputContentValue),this.extraLine.push("我："+this.inputContentValue),this.text=this.extraLine.join("\n");let n={};n.request_id=this.guid(),n.format="utf-8",n.timestamp=1620358489,n.version=1,n.command="chat";let i={direction:"human_to_ai",type:"text",language:"zh_CN"};i.content=this.composeContent(),i.addition="",n.data=i;let a=JSON.stringify(n);this.sendWebSocketMessage(a),this.inputContentValue=null},talk:function(e){t("log","at pages/index/index.vue:254",this.inputContentValue),this.extraLine.push("我："+this.inputContentValue),this.text=this.extraLine.join("\n");let n={};n.request_id=this.guid(),n.format="utf-8",n.timestamp=1620358489,n.version=1,n.command="chat";let i={direction:"human_to_robot",type:"text",language:"zh_CN"};i.content=this.inputContentValue,i.addition="",n.data=i;let a=JSON.stringify(n);this.sendWebSocketMessage(a)},clearInput:function(e){this.inputContentValue=e.detail.value,e.detail.value.length>0?this.showClearIcon=!0:this.showClearIcon=!1},clearIcon:function(){this.inputContentValue="",this.showClearIcon=!1},S4:()=>(65536*(1+Math.random())|0).toString(16).substring(1),guid(){return this.S4()+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+"-"+this.S4()+this.S4()+this.S4()},async genImgCode(){let e="cms"+this.guid();this.codeImg=this.$serverUrl+"/captcha.jpg?uuid="+e}}},[["render",function(t,n,i,a,o,s){return e.openBlock(),e.createElementBlock("view",null,[e.createElementVNode("view",{class:"uni-padding-wrap uni-common-mt"},[e.createElementVNode("view",{class:"uni-btn-v"},[e.createElementVNode("button",{type:"primary",disabled:!o.canConnect,onClick:n[0]||(n[0]=(...e)=>s.connect&&s.connect(...e))},e.toDisplayString(o.isConnected?"disconnect":"connnect"),9,["disabled"])]),e.createElementVNode("view",{class:"text-box","scroll-y":"true"},[e.createElementVNode("text",null,e.toDisplayString(o.text),1)]),e.createElementVNode("view",{class:"uni-form-item uni-column"},[e.createElementVNode("input",{class:"uni-input","placeholder-style":"color:#F76260",placeholder:"请输入聊天内容",value:o.inputContentValue,onInput:n[1]||(n[1]=(...e)=>s.clearInput&&s.clearInput(...e))},null,40,["value"])]),e.createElementVNode("view",{class:"uni-btn-v"},[e.createElementVNode("button",{type:"primary",disabled:!o.canChat,onClick:n[2]||(n[2]=(...e)=>s.chat&&s.chat(...e))},"send",8,["disabled"])])])])}]]));const n={onLaunch:function(){t("log","at App.vue:4","App Launch")},onShow:function(){t("log","at App.vue:7","App Show")},onHide:function(){t("log","at App.vue:10","App Hide")}};const{app:i,Vuex:a,Pinia:o}={app:e.createVueApp(n)};uni.Vuex=a,uni.Pinia=o,i.provide("__globalStyles",__uniConfig.styles),i._component.mpType="app",i._component.render=()=>{},i.mount("#app")}(Vue);
